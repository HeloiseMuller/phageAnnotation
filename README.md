# Phage Annotation

## Introduction
This pipeline uses existing tools to detect high quality phage sequences in large datasets, starting with a run of VirSorter2 (VS2). As recommended by VS2's GitHub page, this pipeline follows the Sullivan Lab protocole, which consists in running checkV on the VS2's outputs, and then a second run of VS2 of checkV-trimmed sequences. Finally, this pipeline calculate quality scores based on the recommendations of the Sullivan Lab protocole and scores based on the recommendations of the benchmark published in Hegarty et al. (2024).

## Citation
Please cite our paper "Genetic exchange networks bridge mobile DNA vehicles in the bacterial pathogen Listeria monocytogenes"  by Muller et al.  (Publication to come).

In addition, please cite the tools and benchmarks we used to develop this pipeline:
- VirSorter2
- checkV
- the Sullivan Lab protocole(https://www.protocols.io/view/viral-sequence-identification-sop-with-virsorter2-5qpvoyqebg4o/v3?step=1) 
- Hegarty et al. (2024)(https://journals.asm.org/doi/10.1128/msystems.01105-23)

## Requirements
- [R](https://cran.r-project.org) 4.3+ with the following packages:
  - [data.table](https://cran.r-project.org/web/packages/data.table/) 1.16.2
  - [stringi](https://cran.r-project.org/web/packages/stringi/) 1.8.4
  - [dplyr](https://cran.r-project.org/web/packages/dplyr/) 1.1.4

  (If not found, these packages are installed automatically by the pipeline.) 

- [virsorter2](https://anaconda.org/bioconda/virsorter) 2.2.4
- [checkV](https://anaconda.org/bioconda/checkv) 1.0.3

The pipeline was not tested with other versions of the above programs, but other versions probably work.  

## Installation
In a bash-compatible terminal that can execute git, paste
```
git clone https://github.com/HeloiseMuller/phageAnnotation.git
cd phageAnnotation/
```

## STEP 1: run VS2 + checkV + VS2
This first step has been written to run in array on a slurm server.  
Firstly, create a dataset composed of one fasta file per genome assembly. Each fasta file names must be of the form `PATTERN_XXX_genomic.fna`. `XXX` can be anything.    
Then, prepare the file `dataset.lst` in which each line contains the `PATTERN` of the genome. For example:
```
SRR14908170
SRR14300122
SRR14044052
SRR1657583
SRR14782971
```
where the first fasta file name is `SRR14908170_XXX_genomic.fna`.   


Then, modify the following lines in `phageAnnotation_array.sh` to activate the conda environments in which VS2 and checkV are located on your server:
```
source /network/rit/lab/andamlab/bin/miniconda3/etc/profile.d/conda.sh 
conda activate virsorter2
conda activate checkV
```
If VirSorter2 and checkV are not installed in a conda environment, the above lines should be deleted.  

Also modify the header of `phageAnnotation_main.sh` to set the right amount of ressources to ask for, the right paths, and the `--array` numbers to choose which of the files from `dataset.lst` you want to run the pipeline on (tip: try it on just two genomes first), and how many should run at the same time. This script just  run phageAnnotation_array.sh, but in an array, allowing to easily handle hundreds/thousands of genomes. The arguments of the following command line should be modify to your own paths/project:
```
bash phageAnnotation_array.sh $SLURM_ARRAY_TASK_ID genomesPath outputsPath dataset.lst /network/rit/lab/andamlab/Databases/checkv-db-v1.5/
```
where `genomesPath` is the absolute path where all your genomes (of the form `PATTERN_XXX_genomic.fna`) are located,  
`outputsPath` is the absolute path where all the outputs should be saved at,  
`dataset.lst` is the file you prepared earlier,  
`pathDB` is the absolute path where the checkV's database is located (e.g. /network/rit/lab/andamlab/Databases/checkv-db-v1.5/).

Finally, run the script:
```
sbatch phageAnnotation_main.sh
```

# Output description of STEP 1

In the output path you provided, the pipeline will create on directory for each genome, each of which will contains the following directories:
- `vs2-pass1/` all the outputs generated by the first run of VS2
- `checkv/` all the outputs generated by checkV
- `vs2-pass2/` all the outputs generated by the second run of VS2

## STEP 2: Combine outputs
Once the first step is done for all genomes of the project, go in `outputsPath` and combine their outputs as follow:
```
cat */vs2-pass1/*_final-viral-boundary.tsv > allOutputs_vs2-pass1_final-viral-boundary.tsv
cat */checkv/contamination_named.tsv > allOutputs_contamination_named.tsv
cat */vs2-pass2/*_final-viral-score.tsv > allOutputs_vs2-pass2_final-viral-score.tsv
cat */vs2-pass2/*_final-viral-combined.fa > allOutputs_vs2-pass2_final-viral-combined.fa
```
All these combined files can be copied on a personal machine at this step.

## STEP 3: Run the R script that harmonizes these outputs
This step has not been tested in a slurm server; it is recommended to run it on a personal machine.

To see all options run:
```
Rscript phageAnnotation.R -h
```

The following command line runs the script using the optional -w argument (allowing to get the coordinates of the phage sequences in the genome), filter out sequences shorter than 5000 bp and sequences that do not pass at least one of the three tuning removal rule.
```
Rscript phageAnnotation.R -c -allOutputs_contamination_named.tsv -v allOutputs_vs2-pass2_final-viral-score.tsv -f 1 -l 5000 -w allOutputs_vs2-pass1_final-viral-boundary.tsv
```

# Output description of STEP 3
TO COMPLETE

## STEP 4 (optional): Remove filtered phages from fasta
```
seqtk subseq allOutputs_vs2-pass2_final-viral-combined.fa  phages_filtered_5000bp_AND_3TuningRemoval.lst > phages_filtered.fasta
```






